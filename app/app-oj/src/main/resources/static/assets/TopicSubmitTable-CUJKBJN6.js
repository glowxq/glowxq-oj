import{d as re,r as g,b as R,w as F,o as c,c as b,a as s,j as i,k as p,u as $,dC as ce,t as n,b0 as ue,m as y,dD as de,x as B,bS as me,bn as pe,y as be,P as M,Q as _e,n as q,W as T,Z as ve,V as fe,f as w,p as he,_ as ge}from"./index-DTkCE7MD.js";import{g as ye}from"./topicSubmit-D3ViFuzS.js";import{J as W}from"./JudgeStatusShow-BtDm6N5o.js";import{F as we,h as Se}from"./FileSaver.min-BnsyPtRb.js";import"./JudgeStatus-By11LX14.js";const ke={class:"submit-section"},xe={class:"section-header"},Ne={class:"title"},Ce={class:"actions"},Te=["disabled"],Ie={class:"button-content"},Ee={key:0,class:"loading-spinner"},De=["disabled"],$e={class:"button-content"},Ve={key:0,class:"loading-spinner"},Ae={class:"button-content"},je={class:"button-text"},Be={key:0,class:"loading-container"},Me={key:2,class:"submit-table-wrapper"},Xe={class:"user-info-cell"},Le={class:"user-name-wrapper"},Ke={class:"user-name"},Pe={key:0,class:"user-nickname"},Ue={class:"score-cell"},Je={class:"ac-num-cell"},Oe=["onClick"],ze={class:"problem-key"},Re={class:"problem-title"},Fe=["onClick"],qe={class:"problem-status"},We={class:"problem-score"},He={key:0,class:"problem-time"},Qe={key:1,class:"problem-status no-submit"},Ze={class:"detail-item"},Ge={class:"detail-value"},Ye={class:"detail-item"},et={class:"detail-value"},tt={class:"detail-item"},st={class:"detail-value"},at={key:0,class:"detail-item"},lt={class:"detail-value"},ot={key:1,class:"detail-item"},nt={class:"detail-value"},it={key:2,class:"detail-item"},rt={class:"detail-value"},ct={class:"detail-item"},ut={class:"detail-value"},dt={class:"detail-item"},mt={class:"detail-value"},pt={class:"detail-item"},bt={class:"detail-value"},_t={class:"detail-item"},vt={class:"detail-value"},ft=re({__name:"TopicSubmitTable",props:{topicId:{type:Number,required:!0},title:{type:String,default:"成绩单"},topicJudgeType:{type:Number,default:0},topicName:{type:String,default:""},headerBgColor:{type:String,default:"#f9f9f9"},loading:{type:Boolean,default:!1}},emits:["update:loading","error"],setup(I,{emit:H}){he(t=>({"75c32cbf":I.headerBgColor}));const S=I,X=H,d=g({users:[],problems:[],submissions:{}}),V=g(!1),A=g(!1),L=g(!1),K=g(!1),k=g(null),h=g(null),P=g(null),E=g(!1),j=R(()=>d.value.users&&d.value.users.length>0&&d.value.problems&&d.value.problems.length>0),U=R(()=>{const t=[];return j.value?(d.value.users.forEach(e=>{const l=d.value.submissions[e.userId]||{};let _=0,f=0;const v={};d.value.problems.forEach(r=>{const u=l[r.problemId];u&&(v[r.problemId]=u,_+=u.score||0,u.judgeStatus===0&&f++)}),t.push({userId:e.userId,userName:e.name,nickName:e.nickName,avatar:e.avatar,totalScore:e.totalScore||_,acNum:e.totalAcNum||f,problems:v})}),t.sort((e,l)=>l.totalScore-e.totalScore)):t}),Q=t=>t===void 0?"未提交":{[-10]:"未提交",[-4]:"已取消",[-3]:"格式错误",[-2]:"编译错误",[-1]:"答案错误",0:"通过",1:"超时",2:"内存超限",3:"运行时错误",4:"系统错误",5:"等待中",6:"编译中",7:"评测中",8:"部分通过",9:"提交中",10:"提交失败",15:"无状态"}[t]||"未知状态",Z=t=>t?{0:"accepted",1:"time-limit",2:"wrong-answer",3:"compile-error",4:"runtime-error",5:"memory-limit",6:"system-error",7:"judging",8:"waiting"}[t.judgeStatus]||"unknown":"no-submission",G=t=>t?t.charAt(0).toUpperCase():"?",J=t=>{if(t==null)return"-";if(t<60)return`${t}分钟`;const e=Math.floor(t/60),l=t%60;return l===0?`${e}小时`:`${e}小时${l}分钟`},Y=(t,e)=>t?t.length>e?t.substring(0,e)+"...":t:"",ee=(t,e)=>{console.log("单元格点击",t,e)},te=(t,e)=>{!t||!e||!t.problems[e.problemId]||(k.value=t.problems[e.problemId],h.value=e,P.value=t,L.value=!0)},se=t=>{t&&(h.value=t,K.value=!0)},ae=async()=>{if(!j.value){T.warning("暂无数据可导出");return}V.value=!0;try{let t;try{t=await ve(()=>import("./xlsx-B6sNpj_1.js"),[]),t.default&&typeof t.default=="object"&&(t=t.default)}catch(o){if(console.error("动态导入xlsx失败，尝试使用全局变量",o),typeof window<"u"&&window.XLSX)t=window.XLSX;else throw new Error("无法加载XLSX库，请检查依赖配置")}const e=[[`${S.topicName||"主题"} - 成绩单统计表`],[""],["序号","用户名","昵称","总分","AC题数","提交总数",...d.value.problems.map(o=>`${o.problemKey}(${o.maxScore}分)
${o.problemTitle}`)]];U.value.forEach((o,D)=>{const x=[D+1,o.userName,o.nickName||"",o.totalScore,o.acNum,Object.keys(o.problems).length];d.value.problems.forEach(a=>{const m=o.problems[a.problemId];if(m){const N=Q(m.judgeStatus);x.push(`${m.score||0}分
${N}`)}else x.push("未提交")}),e.push(x)});const l=t.utils.aoa_to_sheet(e),_={s:{r:0,c:0},e:{r:0,c:6+d.value.problems.length-1}};l["!merges"]||(l["!merges"]=[]),l["!merges"].push(_);const f=[{wch:6},{wch:15},{wch:15},{wch:8},{wch:8},{wch:8}];d.value.problems.forEach(()=>{f.push({wch:20})}),l["!cols"]=f;const v=t.utils.book_new();t.utils.book_append_sheet(v,l,"成绩单");const r=t.write(v,{bookType:"xlsx",type:"array"}),u=new Blob([r],{type:"application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"});we.saveAs(u,`${S.topicName||"主题"}成绩单-${new Date().toISOString().split("T")[0]}.xlsx`),T.success("导出成功")}catch(t){console.error("导出Excel失败",t),T.error("导出失败")}finally{V.value=!1}},le=async()=>{if(!j.value){T.warning("暂无数据可导出");return}A.value=!0;try{await fe();const t=document.querySelector(".submit-table-wrapper");if(!t)throw new Error("未找到表格元素");const e=document.createElement("div");e.style.textAlign="center",e.style.fontSize="20px",e.style.fontWeight="bold",e.style.padding="20px 0",e.textContent=`${S.topicName||"主题"} - 成绩单统计表`;const l=document.createElement("div");l.style.backgroundColor="#fff",l.style.padding="20px",l.style.borderRadius="5px";const _=t.cloneNode(!0);_.style.maxHeight="none",l.appendChild(e),l.appendChild(_),document.body.appendChild(l);const v=(await Se(l,{scale:2,useCORS:!0,backgroundColor:"#fff",logging:!1})).toDataURL("image/png"),r=document.createElement("a");r.href=v,r.download=`${S.topicName||"主题"}成绩单-${new Date().toISOString().split("T")[0]}.png`,document.body.appendChild(r),r.click(),document.body.removeChild(r),document.body.removeChild(l),T.success("导出图片成功")}catch(t){console.error("导出图片失败",t),T.error("导出图片失败")}finally{A.value=!1}},oe=async()=>{if(S.topicId){X("update:loading",!0);try{const t=await ye({topicId:S.topicId});if(t.data)if(Array.isArray(t.data)){console.log("收到数据数组:",t.data);const e=[],l=[],_={},f=new Map,v=new Map;t.data.forEach(r=>{const{userId:u,problemId:o,name:D,nickName:x,problemKey:a,problemTitle:m,problemType:N,judgeStatus:O,score:z,useTime:ne}=r;if(u&&!f.has(u)&&(f.set(u,!0),e.push({userId:u,name:D,nickName:x,avatar:"",totalScore:0,totalAcNum:0,totalSubmitNum:0})),o&&!v.has(o)&&(v.set(o,!0),l.push({problemId:o,problemKey:a,problemTitle:m,problemType:N,maxScore:100})),u&&o){_[u]||(_[u]={}),_[u][o]={judgeStatus:O,score:z,submitNum:1,useTime:ne,lastSubmitTime:r.createTime};const C=e.findIndex(ie=>ie.userId===u);C!==-1&&(e[C].totalScore=(e[C].totalScore||0)+(z||0),O===0&&(e[C].totalAcNum=(e[C].totalAcNum||0)+1),e[C].totalSubmitNum=(e[C].totalSubmitNum||0)+1)}}),d.value={users:e,problems:l,submissions:_},console.log("处理后的数据:",d.value)}else d.value=t.data;else d.value={users:[],problems:[],submissions:{}}}catch(t){console.error("获取成绩单失败",t),X("error","获取成绩单失败，请稍后重试"),d.value={users:[],problems:[],submissions:{}}}finally{X("update:loading",!1)}}};return F(()=>S.topicId,t=>{t&&oe()},{immediate:!0}),F(()=>S.topicJudgeType,()=>{}),(t,e)=>{const l=w("el-icon"),_=w("el-skeleton"),f=w("el-empty"),v=w("el-avatar"),r=w("el-table-column"),u=w("el-tooltip"),o=w("el-table"),D=w("el-scrollbar"),x=w("el-dialog");return c(),b("div",ke,[s("div",xe,[s("div",Ne,[i(l,null,{default:p(()=>[i($(ce))]),_:1}),s("span",null,n(I.title),1)]),s("div",Ce,[s("button",{class:"custom-button warning-button",onClick:ae,disabled:V.value},[s("div",Ie,[i(l,{class:"button-icon"},{default:p(()=>[i($(ue))]),_:1}),e[3]||(e[3]=s("span",{class:"button-text"},"导出Excel",-1)),V.value?(c(),b("div",Ee)):y("",!0)])],8,Te),s("button",{class:"custom-button success-button",onClick:le,disabled:A.value},[s("div",$e,[i(l,{class:"button-icon"},{default:p(()=>[i($(de))]),_:1}),e[4]||(e[4]=s("span",{class:"button-text"},"导出图片",-1)),A.value?(c(),b("div",Ve)):y("",!0)])],8,De),s("button",{class:"custom-button default-button",onClick:e[0]||(e[0]=a=>E.value=!E.value)},[s("div",Ae,[i(l,{class:"button-icon"},{default:p(()=>[E.value?(c(),B($(me),{key:0})):(c(),B($(pe),{key:1}))]),_:1}),s("span",je,n(E.value?"展开":"折叠"),1)])])])]),s("div",{class:q(["submit-content",{collapsed:E.value}])},[I.loading?(c(),b("div",Be,[i(_,{rows:5,animated:""})])):j.value?(c(),b("div",Me,[i(D,null,{default:p(()=>[i(o,{data:U.value,border:"",stripe:"",size:"default",class:"submit-table",onCellClick:ee},{default:p(()=>[i(r,{prop:"userName",label:"姓名","min-width":"80",width:"120",fixed:"left"},{default:p(a=>[s("div",Xe,[i(v,{size:32,src:a.row.avatar,class:"user-avatar"},{default:p(()=>[be(n(G(a.row.userName||a.row.nickName)),1)]),_:2},1032,["src"]),s("div",Le,[s("span",Ke,n(a.row.userName||"未知"),1),a.row.nickName?(c(),b("span",Pe,"("+n(a.row.nickName)+")",1)):y("",!0)])])]),_:1}),i(r,{label:"统计信息"},{default:p(()=>[i(r,{prop:"totalScore",label:"总分",width:"80",align:"center",sortable:""},{default:p(a=>[s("div",Ue,n(a.row.totalScore||0),1)]),_:1}),i(r,{prop:"acNum",label:"通过数",width:"80",align:"center",sortable:""},{default:p(a=>[s("div",Je,n(a.row.acNum||0),1)]),_:1})]),_:1}),(c(!0),b(M,null,_e(d.value.problems,a=>(c(),B(r,{key:a.problemId,label:a.problemKey,"min-width":160,align:"center"},{header:p(()=>[s("div",{class:"problem-header-cell",onClick:m=>se(a)},[s("span",ze,n(a.problemKey),1),i(u,{placement:"top",content:a.problemTitle},{default:p(()=>[s("span",Re,n(Y(a.problemTitle,20)),1)]),_:2},1032,["content"])],8,Oe)]),default:p(m=>[s("div",{class:q(["problem-cell",Z(m.row.problems[a.problemId])]),onClick:N=>te(m.row,a)},[m.row.problems[a.problemId]?(c(),b(M,{key:0},[s("div",qe,[i(W,{code:m.row.problems[a.problemId].judgeStatus},null,8,["code"])]),s("div",We,n(m.row.problems[a.problemId].score||0)+"分 ",1),m.row.problems[a.problemId].useTime?(c(),b("div",He,n(J(m.row.problems[a.problemId].useTime)),1)):y("",!0)],64)):(c(),b("div",Qe,"未提交"))],10,Fe)]),_:2},1032,["label"]))),128))]),_:1},8,["data"])]),_:1})])):(c(),B(f,{key:1,description:"暂无做题数据",class:"empty-data"}))],2),i(x,{modelValue:L.value,"onUpdate:modelValue":e[1]||(e[1]=a=>L.value=a),title:"提交详情",width:"600px",class:"submit-detail-dialog","append-to-body":!0},{default:p(()=>{var a,m,N;return[k.value?(c(),b(M,{key:0},[s("div",Ze,[e[5]||(e[5]=s("span",{class:"detail-label"},"题目：",-1)),s("span",Ge,n((a=h.value)==null?void 0:a.problemKey)+" - "+n((m=h.value)==null?void 0:m.problemTitle),1)]),s("div",Ye,[e[6]||(e[6]=s("span",{class:"detail-label"},"提交者：",-1)),s("span",et,n((N=P.value)==null?void 0:N.userName),1)]),s("div",tt,[e[7]||(e[7]=s("span",{class:"detail-label"},"判题状态：",-1)),s("span",st,[i(W,{code:k.value.judgeStatus},null,8,["code"])])]),I.topicJudgeType===1?(c(),b("div",at,[e[8]||(e[8]=s("span",{class:"detail-label"},"得分：",-1)),s("span",lt,n(k.value.score),1)])):y("",!0),k.value.useTime?(c(),b("div",ot,[e[9]||(e[9]=s("span",{class:"detail-label"},"用时：",-1)),s("span",nt,n(J(k.value.useTime)),1)])):y("",!0),k.value.submitNum?(c(),b("div",it,[e[10]||(e[10]=s("span",{class:"detail-label"},"提交次数：",-1)),s("span",rt,n(k.value.submitNum),1)])):y("",!0)],64)):y("",!0)]}),_:1},8,["modelValue"]),i(x,{modelValue:K.value,"onUpdate:modelValue":e[2]||(e[2]=a=>K.value=a),title:"题目详情",width:"600px",class:"problem-detail-dialog","append-to-body":!0},{default:p(()=>[h.value?(c(),b(M,{key:0},[s("div",ct,[e[11]||(e[11]=s("span",{class:"detail-label"},"题号：",-1)),s("span",ut,n(h.value.problemKey),1)]),s("div",dt,[e[12]||(e[12]=s("span",{class:"detail-label"},"标题：",-1)),s("span",mt,n(h.value.problemTitle),1)]),s("div",pt,[e[13]||(e[13]=s("span",{class:"detail-label"},"类型：",-1)),s("span",bt,n(h.value.problemType),1)]),s("div",_t,[e[14]||(e[14]=s("span",{class:"detail-label"},"满分：",-1)),s("span",vt,n(h.value.maxScore),1)])],64)):y("",!0)]),_:1},8,["modelValue"])])}}}),kt=ge(ft,[["__scopeId","data-v-3602e39b"]]);export{kt as default};
