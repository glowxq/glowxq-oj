import{d as Ce,r,w as ke,e as he,o as s,c as m,x as g,k as o,j as t,u as M,G as we,P as $,Q as S,m as F,bJ as Fe,du as Ve,T as Te,a as v,l as xe,y as _,bn as Be,a7 as Ie,z as A,t as V,W as Z,f as d,V as Me,_ as $e}from"./index-DTkCE7MD.js";import{g as j,a as Se,c as qe}from"./metaTag-XZEJwT5o.js";import{g as ze}from"./metaTagCategory-DYsFMRBy.js";const De={class:"meta-tag-select"},Ue={class:"category-option"},Ae={class:"empty-state"},Ne={class:"tag-option"},Le={class:"tag-option"},Ee={key:0,class:"load-more-content"},Pe={key:1,class:"load-more-content loading"},Re={class:"tag-preview"},He={class:"dialog-footer"},Qe=Ce({__name:"TagSelect",props:{modelValue:{default:void 0},multiple:{type:Boolean,default:!1},placeholder:{default:"请选择标签"},clearable:{type:Boolean,default:!0},collapseTags:{type:Boolean,default:!1},collapseTagsTooltip:{type:Boolean,default:!0},showCreateButton:{type:Boolean,default:!0},showCategoryFilter:{type:Boolean,default:!0},frequentTagIds:{default:()=>[]},maxTagCount:{default:10}},emits:["update:modelValue","change","create"],setup(ee,{emit:le}){const b=ee,N=le,i=r(!1),p=r([]),T=r([]),q=r(b.modelValue??(b.multiple?[]:0)),L=r([]),x=r(!1),E=r(!1),P=r(),ae=r(null),y=r(1),G=r(20),h=r(0),C=r(!1),R=r(""),H=r([]),B=r(void 0),Q=r({}),J=["#0071e3","#000000","#FFFFFF","#34c759","#ff3b30","#ffcc00","#5856d6","#ff9500"],n=r({name:"",backgroundColor:"#0071e3",textColor:"#FFFFFF",plain:"false",enable:"true",categoryId:void 0}),oe={name:[{required:!0,message:"请输入标签名称",trigger:"blur"}],backgroundColor:[{required:!0,message:"请选择背景颜色",trigger:"change"}],textColor:[{required:!0,message:"请选择文字颜色",trigger:"change"}]};ke(()=>b.modelValue,e=>{e!==void 0?q.value=e:q.value=b.multiple?[]:0},{immediate:!0});const z=e=>e.plain?{color:e.backgroundColor||"#0071e3",borderColor:e.backgroundColor||"#0071e3",backgroundColor:"transparent"}:{color:e.textColor||"#FFFFFF",backgroundColor:e.backgroundColor||"#0071e3",borderColor:e.backgroundColor||"#0071e3"},I=async e=>{R.value=e,y.value=1,i.value=!0;try{const l=await j({name:e||void 0,enable:"true",page:y.value,limit:G.value,categoryId:B.value});p.value=l.data.rows||[],h.value=l.data.total||0,C.value=p.value.length<h.value,console.log(`加载第${y.value}页, 共${h.value}条, 已加载${p.value.length}条, 是否有更多: ${C.value}`)}catch(l){console.error("获取标签列表失败:",l)}finally{i.value=!1}},O=async()=>{if(!(i.value||!C.value)){i.value=!0,y.value++;try{console.log(`开始加载第${y.value}页数据...`);const e=await j({name:R.value||void 0,enable:"true",page:y.value,limit:G.value,categoryId:B.value});e.data.rows&&e.data.rows.length>0?(p.value=[...p.value,...e.data.rows],console.log(`成功加载${e.data.rows.length}条新数据`)):console.log("未加载到新数据"),h.value=e.data.total||0,C.value=p.value.length<h.value,console.log(`当前共加载${p.value.length}/${h.value}条数据, 是否有更多: ${C.value}`)}catch(e){console.error("加载更多标签失败:",e),y.value--}finally{i.value=!1}}},te=()=>{Me(()=>{const e=document.querySelector(".el-select-dropdown.apple-select-dropdown");if(!e){console.error("找不到下拉框元素");return}e.addEventListener("scroll",l=>{const u=l.target,{scrollTop:c,scrollHeight:f,clientHeight:k}=u;f-c-k<30&&!i.value&&C.value&&(console.log("触发滚动加载"),O())}),console.log("已添加滚动事件监听")})},ne=e=>{se(e),N("update:modelValue",e),N("change",e)},se=e=>{if(!e){L.value=[];return}const l=Array.isArray(e)?e:[e],u=[...p.value,...T.value];L.value=l.map(c=>u.find(k=>k.id===c)||{id:c,name:`标签${c}`,backgroundColor:"#0071e3",textColor:"#FFFFFF",plain:"false"}).filter(Boolean)},re=e=>{e&&(I(""),setTimeout(()=>{te()},300))},ue=e=>{B.value=e,y.value=1,I(R.value)},de=async()=>{try{const e=await ze({enable:"true",page:1,limit:100});H.value=e.data.rows||[]}catch(e){console.error("获取标签分类失败:",e)}},W=async()=>{try{const e=await Se();if(e.data&&e.data.length){const l={};e.data.forEach(u=>{l[u.categoryId]=u.count}),Q.value=l}}catch(e){console.error("获取分类标签数量失败:",e)}},K=e=>{e.stopPropagation(),x.value=!0},ce=()=>{if(!n.value.backgroundColor)return;const e=n.value.backgroundColor,l=parseInt(e.slice(1,3),16),u=parseInt(e.slice(3,5),16),c=parseInt(e.slice(5,7),16),f=(l*299+u*587+c*114)/1e3;n.value.textColor=f>128?"#000000":"#FFFFFF"},ie=async()=>{P.value&&await P.value.validate(async e=>{if(e){E.value=!0;try{const l={...n.value,plain:n.value.plain?"true":"false"};await qe(l),Z.success("标签创建成功"),x.value=!1,I(""),W(),n.value={name:"",backgroundColor:"#0071e3",textColor:"#FFFFFF",plain:"false",enable:"true",categoryId:void 0},N("create")}catch(l){console.error("创建标签失败:",l),Z.error("创建标签失败")}finally{E.value=!1}}})},pe=async()=>{var e;if(!(!b.frequentTagIds||b.frequentTagIds.length===0))try{const l=await j({page:1,limit:100,enable:"true"});(e=l.data.rows)!=null&&e.length&&(T.value=l.data.rows.filter(u=>b.frequentTagIds.includes(Number(u.id))))}catch(l){console.error("获取常用标签失败:",l)}};return he(async()=>{i.value=!0;try{await Promise.all([de(),W(),I(""),pe()])}catch(e){console.error("初始化标签选择器失败:",e)}finally{i.value=!1}}),(e,l)=>{const u=d("el-icon"),c=d("el-tag"),f=d("el-option"),k=d("el-select"),D=d("el-button"),ge=d("el-tooltip"),fe=d("el-empty"),X=d("el-option-group"),me=d("el-input"),w=d("el-form-item"),Y=d("el-color-picker"),ve=d("el-switch"),ye=d("el-form"),_e=d("el-dialog");return s(),m("div",De,[e.showCategoryFilter?(s(),g(k,{key:0,modelValue:B.value,"onUpdate:modelValue":l[0]||(l[0]=a=>B.value=a),clearable:"",filterable:"",placeholder:"选择标签分类",class:"category-select","popper-class":"apple-select-dropdown category-dropdown",onChange:ue},{prefix:o(()=>[t(u,{class:"category-icon"},{default:o(()=>[t(M(we))]),_:1})]),default:o(()=>[(s(!0),m($,null,S(H.value,a=>(s(),g(f,{key:a.id,label:a.name,value:a.id},{default:o(()=>[v("div",Ue,[v("span",null,V(a.name),1),a.id!==void 0&&Q.value[a.id]?(s(),g(c,{key:0,size:"small",type:"info",class:"count-tag"},{default:o(()=>[_(V(Q.value[a.id]),1)]),_:2},1024)):F("",!0)])]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue"])):F("",!0),t(k,{modelValue:q.value,"onUpdate:modelValue":l[1]||(l[1]=a=>q.value=a),multiple:e.multiple,"collapse-tags":!1,"max-collapse-tags":e.maxTagCount,"collapse-tags-tooltip":e.collapseTagsTooltip,filterable:"",remote:"","remote-method":I,loading:i.value,placeholder:e.placeholder,clearable:e.clearable,class:"apple-select enhanced-tag-select","popper-class":"apple-select-dropdown custom-tag-select-dropdown",onChange:ne,onVisibleChange:re},Fe({tag:o(({closable:a,onClose:be})=>[(s(!0),m($,null,S(L.value,U=>(s(),g(c,{key:U.id,closable:a,style:A(z(U)),effect:U.plain==="true"?"plain":"dark",class:"custom-tag",onClose:be},{default:o(()=>[_(V(U.name),1)]),_:2},1032,["closable","style","effect","onClose"]))),128))]),empty:o(()=>[v("div",Ae,[t(fe,{description:"暂无匹配标签","image-size":60},{image:o(()=>[t(u,{class:"empty-icon"},{default:o(()=>[t(M(xe))]),_:1})]),default:o(()=>[e.showCreateButton?(s(),g(D,{key:0,type:"primary",size:"small",class:"apple-button",onClick:K},{default:o(()=>l[9]||(l[9]=[_(" 创建新标签 ")])),_:1})):F("",!0)]),_:1})])]),default:o(()=>[T.value.length>0?(s(),g(X,{key:0,label:"常用标签"},{default:o(()=>[(s(!0),m($,null,S(T.value,a=>(s(),g(f,{key:a.id,label:a.name,value:a.id},{default:o(()=>[v("div",Ne,[t(c,{style:A(z(a)),effect:"plain",size:"small",class:"apple-tag"},{default:o(()=>[_(V(a.name),1)]),_:2},1032,["style"])])]),_:2},1032,["label","value"]))),128))]),_:1})):F("",!0),p.value.length>0?(s(),g(X,{key:1,label:T.value.length?"所有标签":void 0},{default:o(()=>[(s(!0),m($,null,S(p.value,a=>(s(),g(f,{key:a.id,label:a.name,value:a.id},{default:o(()=>[v("div",Le,[t(c,{style:A(z(a)),effect:a.plain?"plain":"dark",size:"small",class:"apple-tag"},{default:o(()=>[_(V(a.name),1)]),_:2},1032,["style","effect"])])]),_:2},1032,["label","value"]))),128))]),_:1},8,["label"])):F("",!0),C.value?(s(),m("div",{key:2,class:"load-more-button",ref_key:"loadMoreRef",ref:ae,onClick:O},[i.value?(s(),m("div",Pe,[t(u,{class:"is-loading"},{default:o(()=>[t(M(Ie))]),_:1}),l[11]||(l[11]=v("span",null,"正在加载...",-1))])):(s(),m("div",Ee,[t(u,null,{default:o(()=>[t(M(Be))]),_:1}),l[10]||(l[10]=v("span",null,"加载更多标签",-1))]))],512)):F("",!0)]),_:2},[e.showCreateButton?{name:"prefix",fn:o(()=>[t(ge,{content:"创建新标签",placement:"top"},{default:o(()=>[t(D,{class:"create-tag-btn",icon:M(Ve),circle:"",type:"primary",onClick:Te(K,["stop"])},null,8,["icon"])]),_:1})]),key:"0"}:void 0]),1032,["modelValue","multiple","max-collapse-tags","collapse-tags-tooltip","loading","placeholder","clearable"]),t(_e,{modelValue:x.value,"onUpdate:modelValue":l[8]||(l[8]=a=>x.value=a),title:"创建新标签",width:"420px",class:"create-tag-dialog","append-to-body":"","destroy-on-close":""},{footer:o(()=>[v("div",He,[t(D,{class:"apple-button cancel",onClick:l[7]||(l[7]=a=>x.value=!1)},{default:o(()=>l[12]||(l[12]=[_("取消")])),_:1}),t(D,{type:"primary",class:"apple-button create",onClick:ie,loading:E.value},{default:o(()=>l[13]||(l[13]=[_("创建")])),_:1},8,["loading"])])]),default:o(()=>[t(ye,{ref_key:"tagFormRef",ref:P,model:n.value,rules:oe,"label-width":"80px"},{default:o(()=>[t(w,{label:"标签名称",prop:"name"},{default:o(()=>[t(me,{modelValue:n.value.name,"onUpdate:modelValue":l[2]||(l[2]=a=>n.value.name=a),placeholder:"请输入标签名称",class:"apple-input"},null,8,["modelValue"])]),_:1}),t(w,{label:"标签分类",prop:"categoryId"},{default:o(()=>[t(k,{modelValue:n.value.categoryId,"onUpdate:modelValue":l[3]||(l[3]=a=>n.value.categoryId=a),placeholder:"请选择标签分类",filterable:"",clearable:"",class:"apple-select","popper-class":"apple-select-dropdown"},{default:o(()=>[(s(!0),m($,null,S(H.value,a=>(s(),g(f,{key:a.id,label:a.name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(w,{label:"背景颜色",prop:"backgroundColor"},{default:o(()=>[t(Y,{modelValue:n.value.backgroundColor,"onUpdate:modelValue":l[4]||(l[4]=a=>n.value.backgroundColor=a),predefine:J,onChange:ce},null,8,["modelValue"])]),_:1}),t(w,{label:"文字颜色",prop:"textColor"},{default:o(()=>[t(Y,{modelValue:n.value.textColor,"onUpdate:modelValue":l[5]||(l[5]=a=>n.value.textColor=a),predefine:J},null,8,["modelValue"])]),_:1}),t(w,{label:"镂空效果",prop:"plain"},{default:o(()=>[t(ve,{modelValue:n.value.plain,"onUpdate:modelValue":l[6]||(l[6]=a=>n.value.plain=a),class:"apple-switch"},null,8,["modelValue"])]),_:1}),t(w,{label:"预览"},{default:o(()=>[v("div",Re,[t(c,{style:A(z(n.value)),effect:n.value.plain?"plain":"dark",size:"small",class:"apple-tag"},{default:o(()=>[_(V(n.value.name||"标签预览"),1)]),_:1},8,["style","effect"])])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),Oe=$e(Qe,[["__scopeId","data-v-ebee3759"]]);export{Oe as M};
