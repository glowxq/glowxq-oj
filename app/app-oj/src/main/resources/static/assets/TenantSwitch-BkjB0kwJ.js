import{d as oe,v as ne,r as f,q as se,w as le,e as re,o as c,c as u,j as a,k as n,a as o,u as r,X as S,t as g,y as b,x as C,m as I,aJ as z,az as ce,M as ie,i as de,P as ue,Q as pe,aK as O,a8 as me,W as p,aa as _e,a4 as fe,a5 as ve,a6 as ge,a1 as R,f as i,g as ye,n as we,T as G,aL as he,aM as ke,_ as be}from"./index-DTkCE7MD.js";import{a as Ce,g as Ne,b as Te}from"./tenant-BWmX3Yn9.js";const xe={key:0,class:"tenant-switch"},Se={class:"current-tenant"},Ie={class:"tenant-trigger"},Ae={class:"tenant-label"},Ue={class:"tenant-popover-content"},Le={class:"tenant-header"},Ve={class:"tenant-title-wrapper"},Ee={class:"current-tenant-name"},Be={class:"tenant-search"},De={class:"tenant-list"},Ke={key:0,class:"tenant-grid"},$e=["onClick"],Pe={class:"tenant-item-left"},Me={class:"tenant-logo"},qe=["src"],ze={class:"tenant-info"},Oe={class:"tenant-name"},Re={class:"tenant-code"},Ge={class:"tenant-item-right"},Qe={key:2,class:"lock-wrapper",title:"需要密码验证"},We={key:1,class:"tenant-empty"},Xe={class:"password-dialog-content"},je={class:"tenant-info-display"},Je={class:"tenant-logo-container"},Fe=["src"],He={class:"tenant-name-display"},Ye={class:"tenant-id-display"},Ze={key:0,class:"password-error"},et={class:"dialog-footer"},tt=oe({__name:"TenantSwitch",setup(at){const d=ne(),v=f([]),N=f(""),k=f(!1),Q=se(),T=f(!0),w=f(!1),m=f(null),h=f(""),y=f(""),A=f(!1),U=()=>[{id:1,tenantId:"GLOWXQ0000",tenantCode:"GLOWXQ0000",tenantName:"Glowxq-OJ",contactName:"吴一一",contactPhone:"19323030408",contactEmail:"glowxq@qq.com",show:!0,password:"123456",enable:!0,expiredTime:"2099-06-06 16:36:35",maxUserNum:1e5,currentUserNum:1,logoUrl:"",text:"",systemName:"",homeImageUrl:"",themeColor:"#1890ff",config:"",customDomain:""}],B=async()=>{k.value=!0;try{const e=await Ce();console.log("租户列表API返回数据:",e),e.code==="0000"&&e.data?typeof e.data=="object"&&"rows"in e.data&&Array.isArray(e.data.rows)?(v.value=e.data.rows,console.log("获取租户列表成功 (分页格式):",e.data.rows)):Array.isArray(e.data)?(v.value=e.data,console.log("获取租户列表成功 (数组格式):",e.data)):(console.warn("返回的租户数据格式无法识别，使用模拟数据:",e.data),v.value=U()):(console.warn("获取租户列表失败，使用模拟数据:",e.message),v.value=U())}catch(e){console.error("获取租户列表异常，使用模拟数据:",e),v.value=U()}finally{k.value=!1}},W=e=>{if(!e.enable){p.warning("该租户已被禁用，无法切换");return}e.password?(m.value=e,h.value="",y.value="",w.value=!0):L(e)},D=()=>{if(m.value){if(!h.value){y.value="请输入密码";return}y.value="",A.value=!0,setTimeout(()=>{if(h.value===m.value.password)w.value=!1,L(m.value);else{y.value="密码错误，请重新输入";const e=document.querySelector(".password-input");e&&(e.classList.add("shake-animation"),setTimeout(()=>{e.classList.remove("shake-animation")},500))}A.value=!1},500)}},K=async()=>{if(!N.value){p.warning("请输入租户Key");return}k.value=!0;try{const e=await Ne(N.value);console.log("租户搜索API返回数据:",e),e.code==="0000"&&e.data?e.data.password?(m.value=e.data,h.value="",y.value="",w.value=!0):_e.confirm(`是否切换到租户: ${e.data.tenantName}?`,"租户切换确认",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(()=>{L(e.data)}).catch(()=>{}):p.error(e.message||"未找到匹配的租户")}catch(e){console.error("搜索租户失败:",e),p.error("搜索租户时发生错误")}finally{k.value=!1}},L=e=>{console.log("开始切换租户:",e.tenantName),d.setTenantInfo({tenantId:e.tenantId||"",tenantName:e.tenantName||"",tenantCode:e.tenantCode||"",logoUrl:e.logoUrl||"",systemName:e.systemName||"",themeColor:e.themeColor||""}),console.log("租户信息已保存到Store"),p.success({message:`已切换到租户: ${e.tenantName}，即将跳转到登录页`,duration:1500});const t=fe(),s=ve(),_=ge();t.token?setTimeout(()=>{console.log("正在清除用户状态和Token..."),t.clear(),s.clear(),_.close(),console.log("正在跳转到登录页面..."),window.location.href=R},1500):setTimeout(()=>{console.log("未登录状态，直接跳转到登录页面..."),Q.push(R)},1500)},X=e=>{if(!e){p.warning("租户Key不能为空");return}const s=`${window.location.origin}/tenant/${e}`;navigator.clipboard&&window.isSecureContext?navigator.clipboard.writeText(s).then(()=>{p.success("租户直达链接已复制到剪贴板")}).catch(_=>{console.warn("Clipboard API 复制失败，尝试降级方案",_),$(s)}):$(s)},$=e=>{const t=document.createElement("textarea");if(t.value=e,t.style.fontSize="16px",t.style.position="fixed",t.style.left="-999999px",t.style.top="-999999px",t.style.opacity="0",t.style.pointerEvents="none",document.body.appendChild(t),navigator.userAgent.match(/ipad|ipod|iphone/i)){const s=document.createRange();s.selectNodeContents(t);const _=window.getSelection();_&&(_.removeAllRanges(),_.addRange(s)),t.setSelectionRange(0,999999)}else t.select(),t.focus();try{document.execCommand("copy")?p.success("租户直达链接已复制到剪贴板"):p.error("复制失败，请手动复制链接："+e)}catch(s){console.error("复制操作失败",s),p({message:`复制失败，请手动复制此链接：${e}`,type:"warning",duration:1e4,showClose:!0})}document.body.removeChild(t)};le(()=>d.themeColor,e=>{e&&document.documentElement.style.setProperty("--el-color-primary",e)},{immediate:!0});const j=async()=>{try{const e=await Te();e.code==="0000"&&e.data&&(T.value=e.data.enable,console.log("租户功能启用状态:",T.value),T.value||d.clearTenantInfo())}catch(e){console.error("获取租户功能启用状态失败:",e)}};return re(()=>{j(),B()}),(e,t)=>{const s=i("el-icon"),_=i("el-tooltip"),P=i("el-badge"),V=i("el-tag"),E=i("el-button"),M=i("el-input"),J=i("el-dropdown-item"),F=i("el-dropdown-menu"),H=i("el-dropdown"),Y=i("el-empty"),Z=i("el-popover"),ee=i("el-dialog"),te=ye("loading");return T.value?(c(),u("div",xe,[a(Z,{placement:"bottom",width:700,trigger:"click",onShow:B},{reference:n(()=>[o("div",Se,[a(P,{value:r(d).tenantName?"active":"click",type:"primary"},{default:n(()=>[a(_,{content:r(d).tenantName?`当前租户: ${r(d).tenantName}`:"点击切换租户",placement:"bottom"},{default:n(()=>[o("div",Ie,[a(s,{class:"toolBar-icon"},{default:n(()=>[a(r(S))]),_:1}),o("span",Ae,g(r(d).tenantName||"切换租户"),1)])]),_:1},8,["content"])]),_:1},8,["value"])])]),default:n(()=>[o("div",Ue,[o("div",Le,[o("div",Ve,[a(s,{class:"tenant-icon"},{default:n(()=>[a(r(S))]),_:1}),t[5]||(t[5]=o("span",{class:"tenant-title"},"租户切换",-1)),a(V,{size:"small",type:"info",effect:"plain",class:"tenant-count-tag"},{default:n(()=>[b(" 共 "+g(v.value.length)+" 个租户 ",1)]),_:1})]),r(d).tenantName?(c(),C(P,{key:0,value:1,type:"primary"},{default:n(()=>[o("span",Ee,g(r(d).tenantName),1)]),_:1})):I("",!0)]),o("div",Be,[a(M,{modelValue:N.value,"onUpdate:modelValue":t[0]||(t[0]=l=>N.value=l),placeholder:"输入租户Key搜索",clearable:"",class:"tenant-key-input",onKeyup:z(K,["enter"])},{prefix:n(()=>[a(s,{class:"search-prefix-icon"},{default:n(()=>[a(r(ce))]),_:1})]),append:n(()=>[a(E,{onClick:K,type:"primary",class:"search-btn"},{default:n(()=>[a(s,null,{default:n(()=>[a(r(ie))]),_:1}),t[6]||(t[6]=o("span",null,"切换",-1))]),_:1})]),_:1},8,["modelValue"])]),de((c(),u("div",De,[v.value.length>0?(c(),u("div",Ke,[(c(!0),u(ue,null,pe(v.value,l=>(c(),u("div",{key:l.id,class:we(["tenant-item",{"is-active":r(d).tenantId===l.tenantId}]),onClick:x=>W(l)},[o("div",Pe,[o("div",Me,[l.logoUrl?(c(),u("img",{key:0,src:l.logoUrl,alt:"logo"},null,8,qe)):(c(),C(s,{key:1},{default:n(()=>[a(r(S))]),_:1}))]),o("div",ze,[o("span",Oe,g(l.tenantName),1),o("span",Re,g(l.tenantCode),1)])]),o("div",Ge,[l.enable?(c(),C(V,{key:0,type:"success",size:"small"},{default:n(()=>t[7]||(t[7]=[b("正常")])),_:1})):(c(),C(V,{key:1,type:"danger",size:"small"},{default:n(()=>t[8]||(t[8]=[b("禁用")])),_:1})),l.password?(c(),u("div",Qe,[a(s,{class:"lock-icon"},{default:n(()=>[a(r(O))]),_:1})])):I("",!0),o("div",{class:"share-dropdown-wrapper",onClick:t[1]||(t[1]=G(()=>{},["stop"])),title:"复制租户链接"},[a(H,{trigger:"click",class:"share-dropdown"},{dropdown:n(()=>[a(F,null,{default:n(()=>[a(J,{onClick:G(x=>X(l.tenantId),["stop"])},{default:n(()=>[a(s,null,{default:n(()=>[a(r(he))]),_:1}),t[9]||(t[9]=o("span",null,"复制租户直达链接",-1))]),_:2},1032,["onClick"])]),_:2},1024)]),default:n(()=>[a(s,{class:"share-icon"},{default:n(()=>[a(r(ke))]),_:1})]),_:2},1024)])])],10,$e))),128))])):(c(),u("div",We,[a(Y,{description:"暂无租户信息"}),t[10]||(t[10]=o("div",{class:"empty-tip"},[o("p",null,"可能原因："),o("ul",null,[o("li",null,"系统中尚未配置任何租户"),o("li",null,"您没有访问租户的权限"),o("li",null,"网络连接问题导致获取失败")])],-1))]))])),[[te,k.value]])])]),_:1}),a(ee,{modelValue:w.value,"onUpdate:modelValue":t[4]||(t[4]=l=>w.value=l),title:"租户密码验证",width:"420px","close-on-click-modal":!1,"append-to-body":!0,"destroy-on-close":""},{footer:n(()=>[o("div",et,[a(E,{onClick:t[3]||(t[3]=l=>w.value=!1),class:"cancel-btn"},{default:n(()=>t[12]||(t[12]=[b("取消")])),_:1}),a(E,{type:"primary",onClick:D,loading:A.value,class:"confirm-btn"},{default:n(()=>t[13]||(t[13]=[b(" 确认 ")])),_:1},8,["loading"])])]),default:n(()=>{var l,x,q;return[o("div",Xe,[o("div",je,[o("div",Je,[(l=m.value)!=null&&l.logoUrl?(c(),u("img",{key:0,src:m.value.logoUrl,alt:"logo",class:"tenant-logo-large"},null,8,Fe)):(c(),C(s,{key:1,class:"tenant-logo-placeholder"},{default:n(()=>[a(r(S))]),_:1}))]),o("p",He,g((x=m.value)==null?void 0:x.tenantName),1),o("p",Ye,g((q=m.value)==null?void 0:q.tenantId),1)]),t[11]||(t[11]=o("p",{class:"password-tip"},"该租户需要密码验证，请输入密码",-1)),a(M,{modelValue:h.value,"onUpdate:modelValue":t[2]||(t[2]=ae=>h.value=ae),type:"password",placeholder:"请输入租户密码","show-password":"",onKeyup:z(D,["enter"]),class:"password-input"},{prefix:n(()=>[a(s,null,{default:n(()=>[a(r(O))]),_:1})]),_:1},8,["modelValue"]),y.value?(c(),u("div",Ze,[a(s,null,{default:n(()=>[a(r(me))]),_:1}),o("span",null,g(y.value),1)])):I("",!0)])]}),_:1},8,["modelValue"])])):I("",!0)}}}),st=be(tt,[["__scopeId","data-v-d4b313da"]]);export{st as T};
